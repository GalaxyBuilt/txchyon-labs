export interface Env {
    // Secret environment variables set via `wrangler secret put`
    LABS_USERNAME: string;
    LABS_PASSWORD: string;

    // Configuration variables from wrangler.toml
    MAIN_SITE_URL: string;
    LABS_HUB_URL: string;
    OMEGA_URL: string;
    ULTIMA_URL: string;
}

export default {
    async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {
        const url = new URL(request.url);
        const path = url.pathname;

        // 1. Route for Omega Labs
        if (path.startsWith('/labs/omega')) {
            const auth = await checkAuth(request, env);
            if (!auth) return promptAuth();

            return proxyRequest(request, env.OMEGA_URL, '/labs/omega');
        }

        // 2. Route for Ultima Labs
        if (path.startsWith('/labs/ultima')) {
            const auth = await checkAuth(request, env);
            if (!auth) return promptAuth();

            return proxyRequest(request, env.ULTIMA_URL, '/labs/ultima');
        }

        // 3. Route for Labs Hub (The Landing Page)
        if (path === '/labs' || path === '/labs/' || path.startsWith('/labs/')) {
            // Note: We don't password protect the main /labs page so people can see the descriptions
            return proxyRequest(request, env.LABS_HUB_URL, '/labs');
        }

        // 4. Default: Route everything else to the main Astro Megablog
        return fetch(new URL(path + url.search, env.MAIN_SITE_URL), request);
    },
};

/**
 * Checks Basic Auth against environment secrets
 */
async function checkAuth(request: Request, env: Env): Promise<boolean> {
    const authHeader = request.headers.get('Authorization');
    if (!authHeader) return false;

    const [scheme, encoded] = authHeader.split(' ');
    if (scheme !== 'Basic' || !encoded) return false;

    const decoded = atob(encoded);
    const [username, password] = decoded.split(':');

    // Note: You must set these using `wrangler secret put LABS_USERNAME` etc.
    return username === env.LABS_USERNAME && password === env.LABS_PASSWORD;
}

/**
 * Returns a 401 response to prompt for credentials
 */
function promptAuth(): Response {
    return new Response('Authentication Required', {
        status: 401,
        headers: {
            'WWW-Authenticate': 'Basic realm="TXchyon Labs"',
        },
    });
}

/**
 * Proxies the request to the target origin, stripping the base path if necessary
 */
async function proxyRequest(request: Request, targetOrigin: string, basePath: string): Promise<Response> {
    const url = new URL(request.url);

    // Strip the prefix so the destination app sees cleaner paths if needed
    // Or keep them if the destination apps are configured to expect them
    // Most Next.js apps on Pages will expect the full path if 'basePath' is set in next.config.ts
    // If you didn't set basePath in Next.js, use: url.pathname = url.pathname.replace(basePath, '')

    const targetUrl = new URL(url.pathname + url.search, targetOrigin);

    const newRequest = new Request(targetUrl, request);
    newRequest.headers.set('X-Forwarded-Host', url.host);

    return fetch(newRequest);
}
